<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DualPay Calculator 2030D17 ‚Äî –ö–∞–ª–æ—è–Ω –ì–æ—Ä–∞–Ω–æ–≤</title>

  <!-- PWA & Meta -->
  <meta name="theme-color" content="#0f172a" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="DualPay Calculator 2030D17" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DualPay Calculator" />
  <meta name="description" content="PWA –∑–∞ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ —Ä–µ—Å—Ç–æ –≤ BGN –∏ EUR ‚Äî DualPay Calculator 2030D17" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">

  <!-- Tailwind Play CDN (single-file friendly) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config: add fonts & custom colors
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bgapp: '#0f172a',
            dualgreen: '#22c55e',
            deepglass: 'rgba(255,255,255,0.04)'
          },
          fontFamily: {
            heading: ['"Baloo 2"', 'cursive'],
            ui: ['Inter', 'system-ui', 'sans-serif']
          },
          boxShadow: {
            'deep-lg': '0 10px 30px rgba(2,6,23,0.7), inset 0 1px 0 rgba(255,255,255,0.02)'
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --rate: 1.95583;
      --bg: #0f172a;
      --tile-opacity: 0.08;
    }

    html,body,#app {
      height: 100%;
      background: var(--bg);
    }

    /* App window */
    .app-window {
      backdrop-filter: blur(8px) saturate(120%);
      -webkit-backdrop-filter: blur(8px) saturate(120%);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      box-shadow: var(--tw-shadow, 0 10px 30px rgba(2,6,23,0.7));
      border: 1px solid rgba(255,255,255,0.03);
    }

    /* Floating patterned background animation */
    .pattern-bg {
      position: absolute;
      inset: 0;
      z-index: 0;
      opacity: var(--tile-opacity);
      background-repeat: repeat;
      background-size: 240px 240px;
      pointer-events: none;
      transform-origin: center;
      animation: float 20s ease-in-out infinite;
      mix-blend-mode: overlay;
      filter: saturate(0.6) brightness(0.9);
    }

    @keyframes float {
      0% { transform: translate3d(-6px,-4px,0) rotate(-1deg) scale(1); }
      50% { transform: translate3d(6px,4px,0) rotate(1deg) scale(1.02); }
      100% { transform: translate3d(-6px,-4px,0) rotate(-1deg) scale(1); }
    }

    /* Animated result */
    .result-enter {
      transform-origin: center;
      transition: transform .28s ease, opacity .28s ease;
    }
    .result-hidden { opacity: 0; transform: translateY(6px) scale(.98); }
    .result-visible { opacity: 1; transform: translateY(0) scale(1); }

    /* Segmented control */
    .segmented button {
      transition: background-color .18s, color .18s;
    }

    /* Small helpers for one-hand UX: bottom spacing on mobile */
    @media (max-width: 640px) {
      .one-hand-spacing { padding-bottom: 18vh; }
    }

    /* For apple icon masking when needed */
    .round-mask { border-radius: 50%; overflow: hidden; }
  </style>
</head>
<body class="font-ui text-slate-200 antialiased">
  <div id="app" class="min-h-screen flex items-center justify-center p-6 relative">

    <!-- Patterned background (SVG encoded at runtime) -->
    <div id="pattern" class="pattern-bg rounded-xl" aria-hidden="true"></div>

    <!-- App window -->
    <main class="relative z-10 w-full max-w-xl app-window rounded-2xl p-5 sm:p-8 one-hand-spacing">
      <header class="flex items-center gap-4">
        <!-- Tile with green background, rounded corners, contains icons and DualPay -->
        <div class="flex-none rounded-xl bg-dualgreen p-3 shadow deepglass" style="min-width:64px;min-height:64px;">
          <div class="w-10 h-10 round-mask bg-gradient-to-br from-sky-600 to-emerald-400 flex items-center justify-center text-white text-2xl font-heading leading-none">
            <!-- small stylized ‚Ç¨ and –ª–≤ -->
            <svg viewBox="0 0 64 64" width="36" height="36" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <defs>
                <linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#06b6d4"/><stop offset="1" stop-color="#16a34a"/></linearGradient>
              </defs>
              <rect width="64" height="64" rx="12" fill="url(#g)"/>
              <text x="12" y="40" font-family="Baloo 2, serif" font-weight="700" font-size="22" fill="white">‚Ç¨–ª–≤</text>
            </svg>
          </div>
        </div>

        <div>
          <h1 class="text-white font-heading text-2xl leading-tight">DualPay Calculator</h1>
          <p class="text-slate-300 text-sm mt-0.5">PWA ‚Ä¢ –†–µ—Å—Ç–æ –≤ BGN & EUR ‚Äî –ê–≤—Ç–æ—Ä: –ö–∞–ª–æ—è–Ω –ì–æ—Ä–∞–Ω–æ–≤</p>
        </div>
        <div class="ml-auto text-right">
          <div id="install-hint" class="text-xs text-slate-400">–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ</div>
        </div>
      </header>

      <section class="mt-6 grid gap-4">
        <!-- –°—É–º–∞ –∑–∞ –ø–ª–∞—â–∞–Ω–µ -->
        <label class="block">
          <span class="text-slate-300 text-sm">–°—É–º–∞ –∑–∞ –ø–ª–∞—â–∞–Ω–µ</span>
          <div class="mt-2 flex gap-2">
            <input id="amount" inputmode="decimal" type="text" placeholder="0.00"
                   class="flex-1 rounded-xl px-4 py-3 bg-slate-100 text-slate-900 placeholder-slate-500 focus:outline-none"
                   aria-label="–°—É–º–∞ –∑–∞ –ø–ª–∞—â–∞–Ω–µ" />
            <select id="amount-currency" class="rounded-xl px-3 py-3 bg-white/6 text-slate-200">
              <option value="BGN">BGN ‚Äî –ª–≤</option>
              <option value="EUR">EUR ‚Äî ‚Ç¨</option>
            </select>
          </div>
        </label>

        <!-- –ü–ª–∞—Ç–µ–Ω–æ –ø–æ–ª–µ—Ç–∞ -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="block">
            <span class="text-slate-300 text-sm">–ü–ª–∞—Ç–µ–Ω–æ –≤ –ª–≤</span>
            <input id="paid-bgn" inputmode="decimal" type="text" placeholder="0.00"
                   class="mt-2 rounded-xl px-4 py-3 bg-slate-800/60 text-slate-100 focus:outline-none" />
          </label>
          <label class="block">
            <span class="text-slate-300 text-sm">–ü–ª–∞—Ç–µ–Ω–æ –≤ ‚Ç¨</span>
            <input id="paid-eur" inputmode="decimal" type="text" placeholder="0.00"
                   class="mt-2 rounded-xl px-4 py-3 bg-slate-800/60 text-slate-100 focus:outline-none" />
          </label>
        </div>

        <!-- Error box when insufficient -->
        <div id="error-box" class="hidden rounded-xl p-3 bg-red-600/10 border border-red-600 text-red-300">
          <strong id="error-msg" class="block text-sm"></strong>
        </div>

        <!-- –†–µ–∑—É–ª—Ç–∞—Ç -->
        <div id="result-card" class="result-enter result-hidden rounded-2xl p-4 bg-gradient-to-b from-white/3 to-white/2 border border-white/6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-slate-300">–†–µ—Å—Ç–æ</div>
              <div id="change-primary" class="mt-1 text-2xl font-semibold text-white font-ui">‚Äî</div>
              <div id="change-secondary" class="text-xs text-slate-400 mt-1">‚Äî</div>
            </div>

            <div class="segmented inline-flex rounded-xl bg-white/6 p-1">
              <button id="seg-bgn" class="px-3 py-2 rounded-lg text-sm text-slate-200">BGN</button>
              <button id="seg-eur" class="px-3 py-2 rounded-lg text-sm text-slate-200">EUR</button>
            </div>
          </div>
        </div>

        <!-- Small helper -->
        <p class="text-xs text-slate-400 mt-2">–ü–∏—à–µ—Ç–µ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ –≤ –ø–æ–ª–µ—Ç–∞—Ç–∞; –∏–∑—á–∏—Å–ª–µ–Ω–∏—è—Ç–∞ —Å–µ –ø—Ä–∞–≤—è—Ç –≤ —Ä–µ–∞–ª–Ω–æ –≤—Ä–µ–º–µ. –ó–∞ –¥–µ—Å–µ—Ç–∏—á–Ω–∏ –∏–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ —Ç–æ—á–∫–∞ –∏–ª–∏ –∑–∞–ø–µ—Ç–∞—è.</p>
      </section>

      <footer class="mt-6 text-center text-slate-400 text-xs">
        <div>–ö—É—Ä—Å: 1 EUR = 1.95583 BGN</div>
        <div class="mt-1">–ö–∞–ª–æ—è–Ω –ì–æ—Ä–∞–Ω–æ–≤ ¬© 2026</div>
      </footer>
    </main>
  </div>

  <script>
    // Constants
    const RATE = 1.95583;

    // Elements
    const amountInput = document.getElementById('amount');
    const amountCurrency = document.getElementById('amount-currency');
    const paidBgnInput = document.getElementById('paid-bgn');
    const paidEurInput = document.getElementById('paid-eur');
    const errorBox = document.getElementById('error-box');
    const errorMsg = document.getElementById('error-msg');
    const resultCard = document.getElementById('result-card');
    const changePrimary = document.getElementById('change-primary');
    const changeSecondary = document.getElementById('change-secondary');
    const segBgn = document.getElementById('seg-bgn');
    const segEur = document.getElementById('seg-eur');

    // formatters
    const fmtBGN = new Intl.NumberFormat('bg-BG', { style: 'currency', currency: 'BGN', maximumFractionDigits: 2 });
    const fmtEUR = new Intl.NumberFormat('bg-BG', { style: 'currency', currency: 'EUR', maximumFractionDigits: 2 });

    // Helpers
    function sanitizeNumber(v) {
      if (v === null || v === undefined) return NaN;
      v = String(v).trim().replace(',', '.');
      if (v === '') return NaN;
      // Remove any non numeric except dot and minus
      v = v.replace(/[^\d.-]/g, '');
      return parseFloat(v);
    }

    function showError(text) {
      errorMsg.textContent = text;
      errorBox.classList.remove('hidden');
      // hide result
      hideResult();
    }
    function hideError() {
      errorBox.classList.add('hidden');
    }

    function showResult() {
      resultCard.classList.remove('result-hidden');
      resultCard.classList.add('result-visible');
    }
    function hideResult() {
      resultCard.classList.add('result-hidden');
      resultCard.classList.remove('result-visible');
    }

    // Segmented control state
    let changeCurrency = 'BGN'; // or 'EUR'
    function setSegmented(currency) {
      changeCurrency = currency;
      if (currency === 'BGN') {
        segBgn.classList.add('bg-white/10', 'text-white');
        segEur.classList.remove('bg-white/10', 'text-white');
      } else {
        segEur.classList.add('bg-white/10','text-white');
        segBgn.classList.remove('bg-white/10','text-white');
      }
      compute();
    }

    segBgn.addEventListener('click', () => setSegmented('BGN'));
    segEur.addEventListener('click', () => setSegmented('EUR'));
    setSegmented('BGN');

    // Main compute function
    function compute() {
      hideError();

      const amountRaw = sanitizeNumber(amountInput.value);
      const currency = amountCurrency.value;
      const paidBgn = sanitizeNumber(paidBgnInput.value) || 0;
      const paidEur = sanitizeNumber(paidEurInput.value) || 0;

      if (isNaN(amountRaw)) {
        hideResult();
        return;
      }

      // Convert amount to BGN for internal calc
      let amountBGN = currency === 'BGN' ? amountRaw : amountRaw * RATE;
      // Round to 2 decimals for currency math
      amountBGN = Math.round((amountBGN + Number.EPSILON) * 100) / 100;

      // Convert payments to BGN
      const totalPaidBGN = Math.round(((paidBgn || 0) + (paidEur || 0) * RATE + Number.EPSILON) * 100) / 100;

      if (totalPaidBGN < amountBGN - 0.001) {
        // insufficient
        const diffBGN = Math.round(((amountBGN - totalPaidBGN) + Number.EPSILON) * 100) / 100;
        const diffEUR = Math.round(((diffBGN / RATE) + Number.EPSILON) * 100) / 100;
        showError(`–ù–µ–¥–æ—Å—Ç–∞—Ç—ä—á–Ω–∞ —Å—É–º–∞ ‚Äî –ª–∏–ø—Å–≤–∞—Ç ${fmtBGN.format(diffBGN)} (${fmtEUR.format(diffEUR)})`);
        return;
      }

      const changeBGN = Math.round(((totalPaidBGN - amountBGN) + Number.EPSILON) * 100) / 100;
      if (changeBGN <= 0.004) {
        changePrimary.textContent = '0.00 –ª–≤';
        changeSecondary.textContent = '0.00 ‚Ç¨';
        showResult();
        return;
      }

      if (changeCurrency === 'BGN') {
        changePrimary.textContent = fmtBGN.format(changeBGN);
        changeSecondary.textContent = fmtEUR.format(Math.round(((changeBGN / RATE) + Number.EPSILON) * 100) / 100);
      } else {
        const changeEUR = Math.round(((changeBGN / RATE) + Number.EPSILON) * 100) / 100;
        changePrimary.textContent = fmtEUR.format(changeEUR);
        changeSecondary.textContent = fmtBGN.format(Math.round(((changeEUR * RATE) + Number.EPSILON) * 100) / 100);
      }

      showResult();
    }

    // Input listeners (real-time)
    [amountInput, amountCurrency, paidBgnInput, paidEurInput].forEach(el => {
      el.addEventListener('input', compute);
      el.addEventListener('change', compute);
    });

    // Initialize with placeholders
    amountInput.value = '';
    paidBgnInput.value = '';
    paidEurInput.value = '';

    // Accessibility: allow Enter to trigger compute
    [amountInput, paidBgnInput, paidEurInput].forEach(el => {
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          compute();
        }
      });
    });

    // Patterned background generation (SVG tile)
    (function generatePattern() {
      // We create a 240x240 tile with strictly alternating symbols in a 4x4 grid
      const tileSize = 240;
      const symbols = ['‚Ç¨', '–ª–≤', '‚Çø', 'üí∂']; // last two used as coin/bill placeholders (coin symbol & euro banknotes emoji)
      // We'll arrange them strictly alternating in rows/cols
      const cols = 4, rows = 4;
      const cellW = tileSize / cols, cellH = tileSize / rows;
      let svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${tileSize}' height='${tileSize}' viewBox='0 0 ${tileSize} ${tileSize}'>`;
      svg += `<rect width='100%' height='100%' fill='${'#0f172a'}' />`;
      svg += `<g fill='#94a3b8' opacity='0.14' font-family='Baloo 2, Inter, sans-serif' font-weight='700' font-size='40' text-anchor='middle' dominant-baseline='central'>`;
      for (let r=0;r<rows;r++) {
        for (let c=0;c<cols;c++) {
          const idx = (r*cols + c) % symbols.length;
          const x = c * cellW + cellW/2;
          const y = r * cellH + cellH/2 + (r%2===0 ? -6 : 6);
          const sym = symbols[(c + r) % symbols.length];
          svg += `<text x='${x}' y='${y}'>${sym}</text>`;
        }
      }
      svg += `</g></svg>`;
      const svgUrl = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
      const patternEl = document.getElementById('pattern');
      patternEl.style.backgroundImage = `url("${svgUrl}")`;
      patternEl.style.opacity = '0.08';
      patternEl.style.backgroundSize = `${tileSize}px ${tileSize}px`;
    })();

    // PWA: generate dynamic SVG icon and manifest blob, register service worker
    (function setupPWA() {
      function generateSVGIcon(size = 512) {
        const gradId = 'g' + Math.random().toString(36).slice(2,8);
        const svg = `
          <svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 512 512'>
            <defs>
              <linearGradient id='${gradId}' x1='0' x2='1'>
                <stop offset='0' stop-color='#0ea5e9'/>
                <stop offset='1' stop-color='#16a34a'/>
              </linearGradient>
              <mask id='m'><rect x='0' y='0' width='512' height='512' rx='120' fill='white'/></mask>
            </defs>
            <rect width='100%' height='100%' rx='120' fill='url(#${gradId})' />
            <!-- diagonal split -->
            <g mask='url(#m)'>
              <rect x='0' y='0' width='512' height='512' fill='url(#${gradId})' />
              <path d='M0,0 L512,0 L512,256 L0,512 Z' fill='rgba(255,255,255,0.06)' />
              <g font-family='Baloo 2, serif' font-size='170' fill='white' font-weight='700' text-anchor='middle' dominant-baseline='middle'>
                <text x='160' y='270' transform='rotate(-12 160 270)'>‚Ç¨</text>
                <text x='360' y='240' transform='rotate(12 360 240)'>–ª–≤</text>
              </g>
            </g>
          </svg>`;
        return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
      }

      // create manifest blob and link it
      const icon512 = generateSVGIcon(512);
      const icon192 = generateSVGIcon(192);
      const manifest = {
        name: "DualPay Calculator 2030D17",
        short_name: "DualPay",
        description: "PWA –∑–∞ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ —Ä–µ—Å—Ç–æ –≤ BGN –∏ EUR",
        start_url: ".",
        display: "standalone",
        background_color: "#0f172a",
        theme_color: "#0f172a",
        icons: [
          { src: icon192, sizes: "192x192", type: "image/svg+xml" },
          { src: icon512, sizes: "512x512", type: "image/svg+xml" }
        ]
      };
      const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
      const manifestURL = URL.createObjectURL(manifestBlob);
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = manifestURL;
      document.head.appendChild(link);

      // apple touch icon
      const appleLink = document.createElement('link');
      appleLink.rel = 'apple-touch-icon';
      appleLink.href = icon512;
      appleLink.sizes = '512x512';
      document.head.appendChild(appleLink);

      // set meta theme-color
      let metaTheme = document.querySelector('meta[name="theme-color"]');
      if (!metaTheme) {
        metaTheme = document.createElement('meta');
        metaTheme.name = 'theme-color';
        document.head.appendChild(metaTheme);
      }
      metaTheme.content = '#0f172a';

      // Service worker: generate a small SW via blob for caching shell (single-file)
      if ('serviceWorker' in navigator) {
        const swCode = `
          const CACHE = 'dualpay-shell-v1';
          const urlsToCache = [
            '/',
          ];
          self.addEventListener('install', (e) => {
            self.skipWaiting();
            e.waitUntil(
              caches.open(CACHE).then(cache => cache.addAll(urlsToCache).catch(()=>{}))
            );
          });
          self.addEventListener('activate', (e) => {
            e.waitUntil(self.clients.claim());
          });
          self.addEventListener('fetch', (e) => {
            // Try network first, fallback to cache
            e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
          });
        `;
        const swBlob = new Blob([swCode], {type: 'application/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).catch(()=>{});
      }

      // Install prompt UX hint (optional)
      let deferredPrompt;
      const installHint = document.getElementById('install-hint');
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installHint.textContent = '–ù–∞—Ç–∏—Å–Ω–µ—Ç–µ —Ç—É–∫ –∑–∞ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ';
        installHint.style.cursor = 'pointer';
        installHint.addEventListener('click', async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          const choice = await deferredPrompt.userChoice;
          deferredPrompt = null;
        }, { once: true });
      });
    })();
  </script>
</body>
</html>
